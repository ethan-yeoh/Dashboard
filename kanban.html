<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Kanban Dashboard</title>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      display: flex;
      flex-direction: column;
      margin: 0;
      padding: 0;
      background: #f7f8fa;
    }

    header {
      text-align: center;
      padding: 16px;
      background: #1f2937;
      color: white;
      font-weight: 600;
      font-size: 1.5rem;
    }

    #board {
      display: flex;
      justify-content: space-around;
      padding: 16px;
      gap: 12px;
    }

    .column {
      background: #e5e7eb;
      padding: 12px;
      border-radius: 12px;
      width: 30%;
      min-height: 400px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }

    .column h2 {
      text-align: center;
      font-weight: 500;
      margin-bottom: 8px;
      font-size: 1.2rem;
    }

    .task {
      background: white;
      padding: 12px;
      margin: 8px 0;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      font-size: 0.95rem;
      transition: transform 0.1s;
    }

    .task:hover {
      transform: translateY(-2px);
    }

    .arrows button {
      background: #2563eb;
      border: none;
      margin: 0 2px;
      cursor: pointer;
      padding: 4px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
    }

    .arrows button:hover svg {
      fill: #1d4ed8;
    }

    .arrows svg {
      width: 16px;
      height: 16px;
      fill: white;
    }
  </style>
</head>
<body>
  <header><h1>Kanban Board</h1></header>
  <div id="board">
    <div class="column" data-status="todo"><h2>To Do</h2><div class="tasks"></div></div>
    <div class="column" data-status="doing"><h2>Doing</h2><div class="tasks"></div></div>
    <div class="column" data-status="done"><h2>Done</h2><div class="tasks"></div></div>
  </div>

  <script type="module">
    import { supabase } from './config.js';
    const MY_UUID = "c5b221ff-cd34-4e83-8a47-3c6a22bbadab";
    const columns = ['todo', 'doing', 'done'];

    // Ensure session exists
    const { data: { session } } = await supabase.auth.getSession();
    if (!session || session.user.id !== MY_UUID) window.location.href = "index.html";

    async function loadTasks() {
      const { data: tasks, error } = await supabase
        .from('kanban_tasks')
        .select('*')
        .eq('user_id', MY_UUID)
        .order('created_at', { ascending: true });

      if (error) { console.error(error); return; }

      columns.forEach(col => document.querySelector(`.column[data-status="${col}"] .tasks`).innerHTML = '');

      tasks.forEach(task => {
        const div = document.createElement('div');
        div.className = 'task';
        div.dataset.id = task.id;

        div.innerHTML = `
          <span>${task.title}</span>
          <span class="arrows">
            ${task.status !== 'todo' ? `
              <button data-dir="left">
                <svg viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg>
              </button>` : ''}
            ${task.status !== 'done' ? `
              <button data-dir="right">
                <svg viewBox="0 0 24 24"><path d="M9 6l6 6-6 6"/></svg>
              </button>` : ''}
          </span>
        `;
        document.querySelector(`.column[data-status="${task.status}"] .tasks`).appendChild(div);
      });
    }

    async function moveTask(taskId, direction) {
      const { data: task } = await supabase
        .from('kanban_tasks')
        .select('*')
        .eq('id', taskId)
        .single();

      if (!task) return;
      let idx = columns.indexOf(task.status);
      if (direction === 'left') idx = Math.max(0, idx - 1);
      if (direction === 'right') idx = Math.min(columns.length - 1, idx + 1);

      const newStatus = columns[idx];
      await supabase
        .from('kanban_tasks')
        .update({ status: newStatus })
        .eq('id', taskId);

      loadTasks();
    }

    document.getElementById('board').addEventListener('click', (e) => {
      if (e.target.tagName === 'BUTTON' || e.target.tagName === 'svg' || e.target.tagName === 'PATH') {
        const button = e.target.closest('button');
        const taskDiv = button.closest('.task');
        moveTask(taskDiv.dataset.id, button.dataset.dir);
      }
    });

    loadTasks();
    setInterval(loadTasks, 30000);
  </script>
</body>
</html>
