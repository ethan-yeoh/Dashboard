<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Kanban Dashboard</title>
  <style>
    body { font-family: sans-serif; display: flex; flex-direction: column; margin: 0; padding: 0; background: #f5f5f5; }
    header { text-align: center; padding: 10px; background: #222; color: white; }
    #board { display: flex; justify-content: space-around; padding: 10px; }
    .column { background: #e0e0e0; padding: 10px; border-radius: 5px; width: 30%; min-height: 400px; box-sizing: border-box; }
    .column h2 { text-align: center; }
    .task { background: white; padding: 8px; margin: 6px 0; border-radius: 3px; display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
    .arrows button { background: #555; color: white; border: none; margin: 0 2px; cursor: pointer; padding: 2px 6px; border-radius: 2px; }
  </style>
</head>
<body>
  <header><h1>Kanban Board</h1></header>
  <div id="board">
    <div class="column" data-status="todo"><h2>To Do</h2><div class="tasks"></div></div>
    <div class="column" data-status="doing"><h2>Doing</h2><div class="tasks"></div></div>
    <div class="column" data-status="done"><h2>Done</h2><div class="tasks"></div></div>
  </div>

  <script type="module">
    import { supabase } from './config.js';

    const MY_UUID = "c5b221ff-cd34-4e83-8a47-3c6a22bbadab"; // your UUID
    const columns = ['todo', 'doing', 'done'];

    // redirect if not logged in
    const { data: { user } } = await supabase.auth.getUser();
    if (!user || user.id !== MY_UUID) window.location.href = "index.html";

    async function loadTasks() {
      const { data: tasks, error } = await supabase
        .from('kanban_tasks')
        .select('*')
        .eq('user_id', MY_UUID)
        .order('created_at', { ascending: true });

      if (error) { console.error(error); return; }

      columns.forEach(col => document.querySelector(`.column[data-status="${col}"] .tasks`).innerHTML = '');

      tasks.forEach(task => {
        const div = document.createElement('div');
        div.className = 'task';
        div.dataset.id = task.id;
        div.innerHTML = `
          <span>${task.title}</span>
          <span class="arrows">
            ${task.status !== 'todo' ? '<button data-dir="left">&larr;</button>' : ''}
            ${task.status !== 'done' ? '<button data-dir="right">&rarr;</button>' : ''}
          </span>
        `;
        document.querySelector(`.column[data-status="${task.status}"] .tasks`).appendChild(div);
      });
    }

    async function moveTask(taskId, direction) {
      const { data: task } = await supabase
        .from('kanban_tasks')
        .select('*')
        .eq('id', taskId)
        .single();

      if (!task) return;
      let idx = columns.indexOf(task.status);
      if (direction === 'left') idx = Math.max(0, idx - 1);
      if (direction === 'right') idx = Math.min(columns.length - 1, idx + 1);

      const newStatus = columns[idx];
      await supabase
        .from('kanban_tasks')
        .update({ status: newStatus })
        .eq('id', taskId);

      loadTasks();
    }

    document.getElementById('board').addEventListener('click', (e) => {
      if (e.target.tagName === 'BUTTON') {
        const taskDiv = e.target.closest('.task');
        moveTask(taskDiv.dataset.id, e.target.dataset.dir);
      }
    });

    loadTasks();
    setInterval(loadTasks, 30000);
  </script>
</body>
</html>
